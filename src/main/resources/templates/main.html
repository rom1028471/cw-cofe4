<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="~{fragments/header :: head-content}"></head>
<body>
<div th:replace="~{fragments/header :: navbar}"></div>

<div class="container mt-4">
    <div class="row mb-3">
        <div class="col-md-6">
            <h1>Каталог товаров</h1>
        </div>
        <div class="col-md-6">
            <form th:action="@{/main}" method="get" class="d-flex">
                <input class="form-control me-2" type="search" name="search" placeholder="Поиск по названию..." th:value="${searchQuery}" aria-label="Search">
                <button class="btn btn-outline-success" type="submit">Поиск</button>
            </form>
        </div>
    </div>

    <div th:if="${successMessage}" class="alert alert-success" th:text="${successMessage}"></div>
    <div th:if="${errorMessage}" class="alert alert-danger" th:text="${errorMessage}"></div>

    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4" th:if="${!products.isEmpty()}">
        <div class="col" th:each="product : ${products}">
            <div class="card h-100 shadow-sm product-card">
                <img th:if="${product.imageName != null}" 
                     th:src="@{/media/products/} + ${product.imageName}" 
                     class="card-img-top product-card-img"
                     alt="${product.name}">
                <img th:if="${product.imageName == null}" 
                     th:src="@{/images/placeholder.png}"  <!-- Заглушка, если нет изображения -->
                     class="card-img-top product-card-img"
                     alt="Изображение отсутствует">
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title" th:text="${product.name}">Название товара</h5>
                    <p class="card-text flex-grow-1" th:text="${product.description}">Описание товара.</p>
                    <p class="card-text"><strong th:text="${#numbers.formatDecimal(product.price, 1, 'COMMA', 2, 'POINT')} + ' руб.'">Цена</strong></p>
                    <div sec:authorize="isAuthenticated()" class="mt-auto">
                        <form th:action="@{/cart/add}" method="post">
                            <input type="hidden" name="productId" th:value="${product.id}"/>
                            <div class="input-group">
                                <input type="number" name="quantity" class="form-control form-control-sm" value="1" min="1" style="width: 60px;">
                                <button type="submit" class="btn btn-primary btn-sm">В корзину</button>
                            </div>
                        </form>
                    </div>
                    <div sec:authorize="!isAuthenticated()" class="mt-auto">
                         <a th:href="@{/login}" class="btn btn-outline-primary btn-sm">Войдите, чтобы купить</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="alert alert-info" th:if="${products.isEmpty()}">
        <p th:if="${searchQuery != null and !searchQuery.isEmpty()}">Товары по запросу "<span th:text="${searchQuery}"></span>" не найдены.</p>
        <p th:if="${searchQuery == null or searchQuery.isEmpty()}">В настоящее время нет доступных товаров.</p>
    </div>
</div>

<div th:replace="~{fragments/footer :: footer-content}"></div>
</body>
</html> 